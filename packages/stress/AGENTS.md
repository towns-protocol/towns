# Overview - Stress Test Package

This file provides guidance for working with the stress test package.

## Stress Test Architecture and Race Conditions

### Root Client and Follower Client Architecture

The stress test uses a distributed architecture:
- **Root client (client 0)**: Runs in container 0 and is responsible for minting space memberships for all test wallets
- **Follower clients**: Run in all containers and wait for memberships before joining spaces

### Membership Minting Synchronization

To prevent race conditions between membership minting and space joining:

1. The root client mints all memberships in `kickoffChat.ts`
2. After all memberships are minted, the root client sends a `MEMBERSHIPS_MINTED:{sessionId}` signal
3. Follower clients in `joinChat.ts` wait for this signal before attempting to join spaces

This prevents the "PERMISSION_DENIED" error that occurs when clients try to create user streams without having space membership.

#### Key Implementation Details

- The synchronization signal is sent to the announce channel as a threaded message
- The wait timeout is controlled by `waitForChannelDecryptionTimeoutMs` (defaults to max of test duration or 20 seconds)
- Removing the 1.1 second delay between membership minting operations significantly improves performance at scale

## Wallet Management

### Transferring Funds Between Seed Phrases

When updating the seed phrase used for stress testing (e.g., in AWS Secrets Manager), you need to transfer ETH funds from wallets generated by the old seed to wallets generated by the new seed.

#### Process

1. **Generate a new seed phrase** (if needed):
   ```bash
   # Use any tool to generate a BIP39 mnemonic, or use the wallet generation tool
   yarn generate-wallets --seed "test test test test test test test test test test test junk" --start 0 --end 1
   ```

2. **Check current balances** of wallets from the old seed:
   ```bash
   yarn transfer-funds check --old-seed "your old seed phrase" --start 0 --end 40
   ```

3. **Transfer funds** from old to new wallets:
   ```bash
   yarn transfer-funds transfer \
     --old-seed "old seed phrase" \
     --new-seed "new seed phrase" \
     --start 0 \
     --end 40 \
     --rpc-url https://sepolia.base.org
   ```

4. **Update the seed phrase** in your environment:
   - For AWS environments: Update the secret in AWS Secrets Manager
   - For local testing: Update the MNEMONIC environment variable

5. **Verify the transfer** by checking balances of the new wallets:
   ```bash
   yarn transfer-funds check --old-seed "new seed phrase" --start 0 --end 40
   ```

#### Important Notes

- The stress tests use 40 wallets by default (indices 0-39)
- Always check balances before transferring to ensure you're not missing any funded wallets
- The transfer tool includes a 10% gas buffer by default to prevent failed transactions
- A 5-second safety delay is built in before transfers begin
- Each wallet's funds are transferred independently, so partial failures won't affect other transfers

#### Command Options

- `--old-seed`: Source seed phrase (required)
- `--new-seed`: Destination seed phrase (required for transfer)
- `--rpc-url`: Custom RPC URL (defaults to https://sepolia.base.org)
- `--start`: Starting wallet index (defaults to 0)
- `--end`: Ending wallet index (defaults to 40)
- `--gas-buffer`: Gas buffer percentage (defaults to 10)

#### Example: Full Migration

```bash
# 1. Check old wallet balances
yarn transfer-funds check --old-seed "your old twelve word mnemonic seed phrase goes here"

# 2. Transfer to new wallets
yarn transfer-funds transfer \
  --old-seed "your old twelve word mnemonic seed phrase goes here" \
  --new-seed "your new twelve word mnemonic seed phrase goes here"

# 3. Verify new wallet balances
yarn transfer-funds check --old-seed "your new twelve word mnemonic seed phrase goes here"
```
