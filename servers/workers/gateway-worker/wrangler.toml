name = "gateway-worker"
main = "src/index.ts"
compatibility_date = "2023-01-20"
account_id="9840f8a36a817b103e00e29a0e2bad6f"
minify = true
node_compat=true
logpush=true

# created with wrangler kv:namespace create "USER" AND wrangler kv:namespace create "USER" --preview
# each entry needs an `id` and `preview_id` for wrangler to work
kv_namespaces = [{binding="USER", id="825ab41e031d40e0a975bb29638c194e", preview_id = "9f43fa046a17415191d44c4aa0444234"}, { binding = "SPACE", id = "ffd17fea5af143b8ba3cde0b7e15ef93", preview_id = "1080657b855c43b58d118c086122aa3b" }]

[dev]
ip = "localhost"
port = 8004
local_protocol = "http"

[vars]
ENVIRONMENT = "development"
CF_API = "https://api.cloudflare.com/client/v4/accounts"
ACCOUNT_ID="9840f8a36a817b103e00e29a0e2bad6f"

# The necessary secrets are:
# AUTH_SECRET
# IMAGE_HASH - cloudflare images account hash
# API_TOKEN - images api token obtained from CF dashboard
# AWS_SECRET_ACCESS_KEY
# AWS_ACCESS_KEY_ID
# for local development, you can add these in .dev.vars
# 
# Not necessary - SKIP_SIWE - if true, skip siwe auth, useful if you are debugging locally via curl, etc.
#
# For production, you can add these in the Cloudflare dashboard or run
# `echo <VALUE> | wrangler secret put <NAME>` for each of these
# for production, the secrets must be deployed behind the production flag
# `echo <VALUE> | wrangler secret put <NAME> --env production`
# OR
# Run `echo <VALUE> | wrangler secret put <NAME>` for each of these

# production routes
# yarn publish:prod
[env.production]
routes = [{ pattern = "gateway-worker.towns.com", custom_domain = true }]
vars = { ENVIRONMENT = "production", CF_API = "https://api.cloudflare.com/client/v4/accounts",  ACCOUNT_ID="9840f8a36a817b103e00e29a0e2bad6f"} # [vars] access, not secrets
services = [ {binding = "authz", service = "siwe-worker-production", environment = "production"} ]
# created with wrangler kv:namespace create "USER" --env production
# created with wrangler kv:namespace create "SPACE" --env production
kv_namespaces = [{ binding = "USER", id = "8b1f2abcf4ca4e56855b7d3774d23612" }, { binding = "SPACE", id = "4f0bf1efdb164939bca166cb4b65b1a0" }]

# BETA below
# production routes
# yarn publish:prod-beta
[env.production-beta]
routes = [{ pattern = "gateway-worker-beta.towns.com", custom_domain = true }]
vars = { ENVIRONMENT = "production-beta", CF_API = "https://api.cloudflare.com/client/v4/accounts",  ACCOUNT_ID="9840f8a36a817b103e00e29a0e2bad6f"} # [vars] access, not secrets
services = [ {binding = "authz", service = "siwe-worker-production-beta", environment = "production"} ]
# created with wrangler kv:namespace create "USER" --env production-beta
# created with wrangler kv:namespace create "SPACE" --env production-beta
kv_namespaces = [{ binding = "USER", id = "b1e29926fc4b45eeba497f687f17a7af" }, { binding = "SPACE", id = "948104f695b84f17aebbb885860ba69a" }]

# test routes
# yarn publish:test-beta
[env.test-beta]
routes = [{ pattern = "gateway-worker-test-beta.towns.com", custom_domain = true }]
vars = { ENVIRONMENT = "test-beta", SKIP_SIWE = true, CF_API = "https://api.cloudflare.com/client/v4/accounts", ACCOUNT_ID="9840f8a36a817b103e00e29a0e2bad6f"} # [vars] access, not secrets
services = [ {binding = "authz", service = "siwe-worker-test-beta", environment = "production"} ]
# created with wrangler kv:namespace create "USER" --env test-beta
# created with wrangler kv:namespace create "SPACE" --env test-beta
kv_namespaces = [{ binding = "USER", id = "bf4fb160bba4497fb49f4ce1383f5dbb" }, { binding = "SPACE", id = "46e3556d43984c3fa028c3553794e740" }]