package testutils

import (
	"bytes"
	"log/slog"
	"regexp"

	"github.com/river-build/river/core/node/dlog"
)

// RemoveJsonTimestamp removes the "time" field from a JSON log line generated by dlog.
func RemoveJsonTimestamp(logOutput string) string {
	// Remove "time" field from output
	re := regexp.MustCompile(`\"time\":\"[^\"]*\",`)
	return string(re.ReplaceAllString(logOutput, `"time":"[TIMESTAMP]",`))
}

func DlogJsonLogger() (*slog.Logger, *bytes.Buffer) {
	buffer := &bytes.Buffer{}
	return slog.New(dlog.NewPrettyJSONHandler(buffer, &dlog.PrettyHandlerOptions{})), buffer
}

func DlogTextLogger() (*slog.Logger, *bytes.Buffer) {
	buffer := &bytes.Buffer{}
	handler := dlog.NewPrettyTextHandler(buffer, &dlog.PrettyHandlerOptions{
		Colors:        dlog.ColorMap_Disabled,
		PrintLongTime: false,
	})
	return slog.New(handler), buffer
}
